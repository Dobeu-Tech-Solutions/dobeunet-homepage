name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Check for outdated packages
        id: outdated
        run: |
          npm outdated --json > outdated.json || true
          cat outdated.json

      - name: Update patch versions
        run: npm update --save

      - name: Run tests after update
        run: |
          npm ci
          npm run lint
          npm run typecheck
          npm run build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: Update dependencies (automated)'
          title: 'ğŸ”„ Automated Dependency Updates'
          body: |
            ## Automated Dependency Updates
            
            This PR updates patch and minor versions of dependencies.
            
            ### Changes
            - Updated dependencies to latest patch versions
            - All tests passing âœ…
            - Build successful âœ…
            
            ### Review Checklist
            - [ ] Review package.json changes
            - [ ] Check bundle size impact
            - [ ] Verify no breaking changes
            - [ ] Test locally if needed
            
            **Created by:** GitHub Actions
            **Branch:** dependency-updates
          branch: dependency-updates
          base: dev
          labels: dependencies, automated
          delete-branch: true

  security-updates:
    name: Security Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Run npm audit fix
        run: |
          npm audit fix --force || true
          npm ci
          npm run lint
          npm run typecheck
          npm run build

      - name: Create Security Update PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: Apply security updates (automated)'
          title: 'ğŸ” Automated Security Updates'
          body: |
            ## Automated Security Updates
            
            This PR applies automated security fixes from npm audit.
            
            ### Changes
            - Applied `npm audit fix`
            - All tests passing âœ…
            - Build successful âœ…
            
            ### Security Impact
            Review the changes carefully for any breaking changes.
            
            **Created by:** GitHub Actions
            **Branch:** security-updates
          branch: security-updates
          base: dev
          labels: security, automated
          delete-branch: true

