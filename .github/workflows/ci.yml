name: CI - Code Quality & Security

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  issues: write

jobs:
  # Dependency Security Audit
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run npm audit fix
        run: npm audit fix --dry-run

      - name: Check for outdated dependencies
        run: npm outdated || true

  # Code Quality Checks
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type checking
        run: npm run typecheck

      - name: Check code formatting
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"
        continue-on-error: false

  # Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # Build Verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed - dist directory not created"
            exit 1
          fi
          echo "Build successful - dist directory exists"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  # Bundle Size Check
  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: dist/

      - name: Check bundle size
        run: |
          echo "Checking bundle sizes..."
          find dist -type f -name "*.js" -o -name "*.css" | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "$file: $size"
          done

      - name: Bundle size report
        run: |
          total_size=$(du -sh dist/ | cut -f1)
          echo "Total bundle size: $total_size"
          if [ $(du -sb dist/ | cut -f1) -gt 524288000 ]; then
            echo "‚ö†Ô∏è Warning: Bundle size exceeds 500MB"
            exit 1
          fi
          echo "‚úÖ Bundle size is acceptable"

  # PR Review Checklist Comment
  pr-review-checklist:
    name: PR Review Checklist
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Comment PR with checklist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## ü§ñ Automated Code Review Checklist
            
            - [ ] Code follows TypeScript best practices
            - [ ] No security vulnerabilities introduced
            - [ ] Bundle size is acceptable
            - [ ] All tests pass
            - [ ] Documentation is updated
            - [ ] No console.log statements in production code
            - [ ] Error handling is comprehensive
            - [ ] Accessibility standards maintained
            - [ ] MongoDB functionality preserved
            - [ ] Dark mode works correctly
            - [ ] Page loads without errors
            
            Review the checks above before merging.`;
            
            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Automated Code Review Checklist')
            );
            
            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Dependency Update Check
  dependency-update:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Check for updates
        run: |
          npm outdated > outdated.txt || true
          cat outdated.txt

      - name: Create issue if updates available
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const outdated = fs.readFileSync('outdated.txt', 'utf8');
            if (outdated.length > 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üîÑ Dependency Updates Available',
                body: `Outdated dependencies detected:\n\n\`\`\`\n${outdated}\n\`\`\`\n\nReview and update as needed.`,
                labels: ['dependencies', 'maintenance']
              });
            }

  # Security Headers Check
  security-headers:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate security headers
        run: |
          echo "Checking _headers file..."
          if [ -f "public/_headers" ]; then
            echo "‚úÖ Security headers file exists"
            cat public/_headers
          else
            echo "‚ùå Security headers file missing"
            exit 1
          fi

      - name: Validate CSP
        run: |
          if grep -q "Content-Security-Policy" public/_headers; then
            echo "‚úÖ CSP header found"
          else
            echo "‚ùå CSP header missing"
            exit 1
          fi

  # All checks passed
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [dependency-audit, code-quality, security-scan, build, bundle-size, security-headers]
    if: always()
    steps:
      - name: Check if all jobs succeeded
        run: |
          # Allow security-scan to fail but still pass overall
          if [ "${{ needs.dependency-audit.result }}" != "success" ] || \
             [ "${{ needs.code-quality.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.bundle-size.result }}" != "success" ] || \
             [ "${{ needs.security-headers.result }}" != "success" ]; then
            echo "‚ùå Some critical checks failed"
            echo "dependency-audit: ${{ needs.dependency-audit.result }}"
            echo "code-quality: ${{ needs.code-quality.result }}"
            echo "security-scan: ${{ needs.security-scan.result }}"
            echo "build: ${{ needs.build.result }}"
            echo "bundle-size: ${{ needs.bundle-size.result }}"
            echo "security-headers: ${{ needs.security-headers.result }}"
            exit 1
          fi
          echo "‚úÖ All checks passed"

      - name: Post success comment on PR
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ All CI checks passed! Ready for review and merge.'
            });

